const EJK_STUDENT_ROLE = 0;
const EJK_TEACHER_ROLE = 1;

function nl2br (str, is_xhtml) {
    var breakTag = (is_xhtml || typeof is_xhtml === 'undefined') ? '<br />' : '<br>';
    return (str + '').replace(/([^>\r\n]?)(\r\n|\n\r|\r|\n)/g, '$1' + breakTag + '$2');
}

function ejk_image_upload(src) {
	if (window.ejk_role == EJK_STUDENT_ROLE) {
		//	Only students are allowed to upload images
		if (window.selected_image != -1) {
			//console.log(src);
			var sourceSplit = src.split("base64,");
			var sourceString = sourceSplit[1];

			/*console.log(encodeURI(sourceString));
			console.log(encodeURI(sourceString).length+" length sent");
			console.log("/jsg.php?op=ejk_hallgato_input&mod=kep&kerdes="+window.selected_image+"&beadas="+window.beadas_id);*/

			$.ajax({
				url: "/jsg.php?op=ejk_hallgato_input&mod=kep&kerdes="+window.selected_image+"&beadas="+window.beadas_id,
				method: "POST",
				data: "tartalom="+encodeURI(sourceString),
				success: function(html){
					console.log("image upload success");
					d = new Date();
					$("#kep_"+window.selected_image).attr("src", "/jsg.php?op=ejk_kep&kerdes="+window.selected_image+"&beadas="+window.beadas_id+"&d="+d.getTime());


					var message = ejk_message_init("IMAGE_UPDATE","");
					message.question = window.selected_image;
					ejk_ws_send_message(message);

					ejk_select_image(-1);
				}
			});
		} else {
			console.log("No image selected. Aborting paste.");
		}
	}
}

function ejk_select_image(kerdes) {
	if (kerdes == -1 || (window.ejk_role == EJK_STUDENT_ROLE && ejk_ws != null))  {
		//	Only students are allowed to select images
		$(".ejk_kivalasztott_kep").removeClass("ejk_kivalasztott_kep");

		if (window.selected_image == kerdes) {
			window.selected_image = -1;
		} else {
			$("#kep_"+kerdes).addClass("ejk_kivalasztott_kep");
			window.selected_image = kerdes;
		}
	}
}

function ejk_lock_field(question, state) {
	if (window.ejk_role == EJK_STUDENT_ROLE) {
		//	Only students are allowed to lock fields

		$(".ejk_kivalasztott_kep").removeClass("ejk_kivalasztott_kep");
		window.selected_image = -1;

		if (ejk_ws.auth_status>-1) {
			if (state == 1) {
				state = "TEXT_LOCK";
			} else {
				state = "TEXT_UNLOCK";
			}

			var message = ejk_message_init(state,"");
			message.question = question;
			ejk_ws_send_message(message);
			console.log(message);
		} else {
			cosole.log("Not authenticated: not sending lock.");
		}
	}
}


/*function ws_test() {
	var wsa = new Array();
	for (i=0; i<10; i++) {
		console.log('Starting websocket '+i);
		wsa.push(new_ws);
	}
	console.log('Done.');
}*/


function ejk_text_changed(id) {
	if (window.ejk_role == EJK_STUDENT_ROLE) {
		//	Only students are allowed to change text

		// Create and send change message
		var message = ejk_message_init("TEXT_UPDATE",$("#szoveg_"+id).val());
		message.question = id;
		ejk_ws_send_message(message);

		// Update question status
		$("#szoveg_"+id).prop('disabled',true);
		$("#statusz_"+id).removeClass().addClass("orange").html("A módosítások mentése folyamatban van.");
	}
}

function ejk_reset_quetion_block_state(id) {
	var blokk = $("#kerdes_blokk_"+id);
	blokk.removeClass("ejk_kerdes_elfogadva").removeClass("ejk_kerdes_elutasitva").removeClass("ejk_kerdes_nyitott");
	return blokk;
}

function ejk_meta_change() {
	if (window.ejk_role == EJK_STUDENT_ROLE) {
		//	Only students are allowed to change meta data
		var message = ejk_message_init("META_UPDATE","");
		message.room = $("#terem").val();
		message.machine = $("#merohely").val();
		ejk_ws_send_message(message);
	}
}

function ejk_message_init(new_type, new_content) {
	var message = {type: new_type, content: new_content};
	return message;
}

function ejk_page_init(ejk_token, beadas_id, szerep) {
	// No image selected
	window.selected_image = -1;

	// Save submission id
	window.beadas_id = beadas_id;

	// Inic clipboard handler
	CLIPBOARD = new CLIPBOARD_CLASS("my_canvas", true);

	// Create websocket connection
	ejk_ws_init(ejk_token);
	window.ejk_role = szerep;
	window.ejk_token = ejk_token;
	window.ejk_connection_attempt = 1;
	window.ejk_auth_success_ever = false;

	// Init auto resize for textarea elements
	$(document).on('keyup', 'textarea', function(e) {
		ejk_auto_resize_textarea($(this));
	});

	// Run auto resize on all existing textarea
	$('textarea').each(function(i, obj) {
		ejk_auto_resize_textarea($(obj));
		//console.log(obj);
	});

	// Init notifications
	window.notifications = [];
	window.notification_visible = false;
	window.permanent_notification = false;

	/*
	setTimeout(function() {
		ejk_show_permanent_notification("Permanent notification on");
	},1000);


	setTimeout(function() {
		ejk_add_notification('6 másodperces értésítés');
	},6000);


	setTimeout(function() {
		ejk_hide_permanent_notification();
	},10000);*/
}

function ejk_auto_resize_textarea(area1) {
	while(area1.outerHeight() < area1.prop('scrollHeight') + parseFloat(area1.css("borderTopWidth")) + parseFloat(area1.css("borderBottomWidth"))) {
		area1.height(area1.height()+1);
	};
}

function ejk_ws_init(ejk_token) {
	window.ejk_connection_attempt++;
	console.log('Attempt: '+window.ejk_connection_attempt);
	if (window.ejk_connection_attempt>1) {
		var connection_text = 'Sikertelen csatalkozás az Elektronikus Jegyzőkönyv Rendszerhez!<br>A kapcsolat létrejöttéig a jegyzőkönyv nem szerkeszthető.<br>Csatlakozás folyamatban ['+window.ejk_connection_attempt+']...';
		ejk_show_permanent_notification(connection_text);
	}
	
	if (window.ejk_connection_attempt>10) {
		var connection_text = 'Nem sikerült a csatalkozás az Elektronikus Jegyzőkönyv Rendszerhez!<br>Töltse újra az oldalt a kapcsolódás újrakezdéséhez!';
		ejk_show_permanent_notification(connection_text);
		return;
	}


	// Websocket létrehozása
	ejk_ws = null;
	ejk_ws = new WebSocket("wss://hf.mit.bme.hu:8084");
	ejk_ws.auth_status = 0;

	// Új üzenet kezelése -> továbbadása a megfelelő függvénynek
	ejk_ws.onmessage = function (event) {
		//ejk_ws_onmessage(JSON.parse(event.data));
		try {
			message = JSON.parse(event.data);
			ejk_ws_onmessage(message);
		} catch (exception) {
			console.log("Unable to JSON decode message: "+event.data +" ("+exception+")");
		}
	}

	// Ha a kapcsolat megszakadt
	ejk_ws.onclose = function(){
		// Schedule connection restart
		ejk_ws_schedule_reconnect(ejk_token);

		// Disable all text fields
		$(".ejk_valasz").prop('disabled', true);
	};


	ejk_ws.onopen = function () {
		// Kapcsolat hitelesítése a kapott tokennel
		setTimeout(function () {
			var message = ejk_message_init('REGISTER',ejk_token);
			ejk_ws_send_message(message);
		}, 300);
	};
}

function ejk_ws_schedule_reconnect() {
	// Kapcsolat helyi oldalának lezárása
	ejk_ws = null;

	console.log("Auth ever: "+window.ejk_auth_success_ever);
	if (!window.ejk_auth_success_ever) {
		// Try again after some time with the original token
		setTimeout(function(){
			ejk_ws_init(ejk_token)
		}, 10000+window.ejk_connection_attempt*10000);
	} else {
		// The original token is already used. Stop trying, only page reload can help.
		ejk_show_permanent_notification('Az elektronikus jegyzőkönyv kapcsolat megszakadt.<br>Kérem töltse újra az oldalt!');
        ejk_select_image(-1);
	}
}

function ejk_ws_onmessage(message) {
	// Üzenet érkezett
	console.log(message);

	if (message.type=='AUTH_FAILURE') {
		// Try to reset connection
		ejk_ws_schedule_reconnect(window.ejk_token);

	} else if (message.type=='AUTH_OK') {
		// Successfull auth
		console.log("Authentication OK for "+message.full_name+" ("+message.neptun+") in role "+message.role+" for submission "+message.submission);
		ejk_ws.auth_status = 1;
		window.ejk_auth_success_ever = true;

		// Enable all text fields that are disabled by default
		$(".ejk_valasz").prop('disabled', false);
		ejk_hide_permanent_notification();

	} else if (message.type=='TEXT_UPDATED') {
		// Update question status

		if (window.ejk_role == EJK_STUDENT_ROLE) {
			// Students have  textarea
			$("#szoveg_"+message.question).prop('disabled',false);
			$("#szoveg_"+message.question).val(message.content);

			// Resize textarea
			ejk_auto_resize_textarea($("#szoveg_"+message.question));
		} else {
			// Teachers have div
			$("#szoveg_"+message.question).html(nl2br(message.content));
		}

		$("#statusz_"+message.question).removeClass().addClass("ejk_gray").html("Utoljára "+message.last_updater+" szerkesztette.");
		ejk_reset_quetion_block_state(message.question).addClass("ejk_kerdes_nyitott");

		$("#ertekeles_blokk_"+message.question).show();

	} else if (message.type=='TEXT_LOCK') {
		$("#szoveg_"+message.question).prop('disabled',true);
		$("#statusz_"+message.question).removeClass().addClass("red").html(message.locker+" épp most szerkeszti.");

	} else if (message.type=='TEXT_UNLOCK') {
		$("#szoveg_"+message.question).prop('disabled',false);
		$("#statusz_"+message.question).removeClass().addClass("ejk_gray").html("Utoljára "+message.locker+" szerkesztette.");

	} else if (message.type=='NOTIFY') {
		ejk_add_notification(message.content);

	} else if (message.type == 'IMAGE_UPDATE') {
		d = new Date();
		$("#kep_"+message.question).attr("src", "/jsg.php?op=ejk_kep&kerdes="+message.question+"&beadas="+window.beadas_id+"&d="+d.getTime());
		$("#ertekeles_blokk_"+message.question).show();
		console.log('Updating image: '+message.question);

		ejk_reset_quetion_block_state(message.question).addClass("ejk_kerdes_nyitott");

	} else if (message.type == 'META_UPDATE') {
		$("#terem").val(message.room);
		$("#merohely").val(message.machine);

	} else if (message.type == 'RATING_UPDATE') {
		if (window.ejk_role == EJK_STUDENT_ROLE) {
			$("#ertekeles_"+message.question).html(message.content);
			if (message.content != "") {
				$("#ertekeles_cimke_"+message.question).show();
			} else {
				$("#ertekeles_cimke_"+message.question).hide();
			}
			$("#pont_"+message.question).html(message.score);
		} else {
			$("#ertekeles_"+message.question).val(message.content);
			$("#pont_"+message.question).val(message.score);
		}

	} else if (message.type == 'ANSWER_STATUS_UPDATE') {
		var blokk = ejk_reset_quetion_block_state(message.question);

		if (message.content == 1) {
            blokk.addClass("ejk_kerdes_elfogadva");
        } else if (message.content == -1) {
            blokk.addClass("ejk_kerdes_elutasitva");
		} else {
            blokk.addClass("ejk_kerdes_nyitott");
        }

        if (window.ejk_role == EJK_TEACHER_ROLE) {
            if ($("#elfogadott-valaszokat-mutat").is(':checked')) {
                $(".ejk_kerdes_elfogadva").show();
            } else {
                $(".ejk_kerdes_elfogadva").hide();
            }
        }
    } else if (message.type == 'RELOAD') {
        location.reload();
    } else if (message.type == 'TOTAL_POINT_UPDATE') {
        $("#total_pont").val(message.total_point);
        $("#imsc_pont").val(message.imsc_point);
	}
}

function ejk_ws_send_message(message) {
	// Üzenet objektum elküldése JSON szöveg formában
	ejk_ws.send(JSON.stringify(message));
}

function ejk_add_notification(text) {
	notifications.push(text);
	ejk_show_notifications();
}

function ejk_show_notifications() {
	// Check if there is anything to display
	if (notifications.length == 0) return;
	if (notification_visible) return;
	if (permanent_notification) return;

	// Pop the oldest notification and show it
	notification_visible = true;
	var text = notifications.shift();
	$("#notification").html(text).fadeIn();

	// Calculate display time based on text length
	/*var el = document.createElement("div");
	el.innerHTML = text;
	var plain_text = el.textContent || el.innerText || "";
  console.log(plain_text.length);*/

	// Schedule notification hiding
	setTimeout(function() {
		$("#notification").fadeOut('slow', function() {
			notification_visible = false;
			ejk_show_notifications();
		});
	},5000);
}

function ejk_show_permanent_notification(text) {
	permanent_notification = true;
	$("#notification").html("").fadeIn('slow', function() {
		$("#notification").html(text);
	});
}

function ejk_hide_permanent_notification() {
	$("#notification").fadeOut('slow', function() {
		notification_visible = false;
		permanent_notification = false;
		ejk_show_notifications();
	});
}

function ejk_rating_changed(id) {
	if (window.ejk_role == EJK_TEACHER_ROLE) {
		//	Only teachers are allowed to rate answers

		// Create and send change message
		var message = ejk_message_init("RATING_UPDATE",$("#ertekeles_"+id).val());
		message.question = id;
		message.score = $("#pont_"+id).val();
		ejk_ws_send_message(message);
	}
}

function ejk_status_changed(id,status) {
	if (window.ejk_role == EJK_TEACHER_ROLE) {
		//	Only teachers are allowed to change answer status

		// Create and send change message
		var message = ejk_message_init("ANSWER_STATUS_UPDATE",status);
		message.question = id;
		ejk_ws_send_message(message);
	}
}

function ejk_set_block_visibility(id,visibility) {
    if (visibility == 0) {
        $("#ejk_blokk_szoveg_"+id).hide();
        $("#ejk_blokk_szoveg_slider_"+id).show();
    } else {
        $("#ejk_blokk_szoveg_"+id).show();
        $("#ejk_blokk_szoveg_slider_"+id).hide();
    }
}

function ejk_set_closed(state) {
    if (window.ejk_role == EJK_TEACHER_ROLE) {
		//	Only teachers can lock or unlock
		var message = ejk_message_init("CHANGE_LOCK_STATE",state);
		ejk_ws_send_message(message);
	}
}

function ejk_total_point_update() {
    if (window.ejk_role == EJK_TEACHER_ROLE) {
        //	Only teachers can update points
        var message = ejk_message_init("TOTAL_POINT_UPDATE","");
        message.total_point = $("#total_pont").val();
        message.imsc_point = $("#imsc_pont").val();
        ejk_ws_send_message(message);
    }
}

function ejk_szoveg_kinyitot_mutat() {
    if ($("#szoveg-kinyitokat-mutat").is(':checked')) {
        $(".ejk_blokk_szoveg_slider").show();
    } else {
        $(".ejk_blokk_szoveg_slider").hide();
        $(".ejk_blokk_szoveg").hide();
    }

}

function ejk_elfogadott_valaszokat_mutat() {
    if ($("#elfogadott-valaszokat-mutat").is(':checked')) {
        $(".ejk_kerdes_elfogadva").show();
    } else {
        $(".ejk_kerdes_elfogadva").hide();
    }

}

function ejk_next_id(id,direction) {
	var array = $(".ejk_kerdes").toArray();
	var prevIndex = -1;
	var nextIndex = -1;
	for (i=0; i<array.length; i++) {
		array[i] = array[i].id.substr(13);
		if (array[i] == id) {
			prevIndex = i-1;
			nextIndex = i+1;
		}
	}
	
	console.log("direction = "+direction+" nextIndex = "+nextIndex+" prevIndex = "+prevIndex+" array.length = "+array.length);
	
	if (direction>0 && nextIndex>0 && nextIndex<array.length) {
		return array[nextIndex];
	} else if (direction<0 && prevIndex >=0) {
		return array[prevIndex];
	}
	return null;
}

function ejk_jump_to_rating(id) {
	if (id == null) {
		console.log("Jump target id is null.");
		return;
	}
	$("#ertekeles_"+id).focus();
	//$("#kerdes_blokk_"+id).scrollTo();
	document.getElementById("kerdes_blokk_"+id).scrollIntoView();

}

function ejk_rating_keydown(event,id) {
	if (event.altKey) {
		if (event.keyCode == 40) {
			// Down
			ejk_jump_to_rating(ejk_next_id(id,1));
		} else if (event.keyCode == 38 ) {
			// Up
			ejk_jump_to_rating(ejk_next_id(id,-1));
		} else if (event.keyCode == 39) {
			// Set green
			ejk_status_changed(id,1);
			ejk_jump_to_rating(ejk_next_id(id,1));
		} else if (event.keyCode == 37) {
			// Set red
			ejk_status_changed(id,-1);
		}
	}
}

function ejk_quick_close(point,imsc) {
	$("#total_pont").val(point);
	$("#imsc_pont").val(imsc);
	ejk_total_point_update();
	
	setTimeout(function() {
		ejk_set_closed(1);
	},500);

}
